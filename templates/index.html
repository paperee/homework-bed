<!DOCTYPE html>
<html manifest="demo.appcache">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no">
        <meta name="Keywords" content="æ±•å¤´å¸‚è¾¾æ¿ åä¾¨ä¸­å­¦,ä¿¡æ¯æŠ€æœ¯è¯¾æœŸæœ«ä½œä¸šç®¡ç†ç³»ç»Ÿ">
        <meta name="Description" content="ä¿¡æ¯æŠ€æœ¯è¯¾æœŸæœ«ä½œä¸šç®¡ç†ç³»ç»Ÿ">
        <link rel="shortcut icon" href="https://paperee.guru/fish.ico">
        <link rel="stylesheet" type="text/css" href="/templates/style.css">
        <script src="/templates/jquery.min.js"></script>
        <script src="/templates/remarkable.min.js"></script>
        <script src="/templates/script.js"></script>
        <script src="/templates/textarea.js"></script>
        <title>ä¿¡æ¯æŠ€æœ¯è¯¾æœŸæœ«ä½œä¸šç®¡ç†ç³»ç»Ÿ</title>
        <style>
            .org {
                background:#EEDDBB;
                padding:1px 8px;
                margin:0 2.5px;
                border-radius:5px;
            }
            .title {
                display:inline-block;
                margin:3% 5% 1% 5%;
            }
            .title h1 {
                font-size:32px;
                padding-bottom:36px;
                display:inline-block;
                margin-right:10px;
            }
            .parent {
                position:relative;
                display:grid;
                grid-template-columns:repeat(14,1fr);
                grid-template-rows:repeat(4,1fr) 0.5fr;
                grid-column-gap:0px;
                grid-row-gap:0px;
            }
            .parent>* {
                padding:12px;
                height:400px;
                background:#FAFAFA;
                border-radius:4px;
                box-shadow:0 0 0 14px #FAFAFA;
            }
            .fileBox {
                display:flex;
                align-items:center;
                margin:20px 16px;
                border-bottom:2px dashed #A69F94;
            }
            .fileBox p {
                flex:1;
                margin-bottom:16px;
            }
            .fileBox p:before {
                content:"ğŸ“ ";
            }
            .fileBox a {
                transform:rotate(-5deg);
            }
            .fileBox a {
                text-decoration:none;
                margin-left:16px;
                margin-bottom:18px;
                background:#E8D8C5;
                border-radius:6px;
                padding:0 10px;
                transition:all 0.2s;
            }
            .fileBox a:hover {
                transform:rotate(2deg);
                background:#DDEEBB;
            }
            .download:before {
                content:"ğŸ“¥ ";
            }
            .delete:before {
                content:"ğŸš« ";
            }
            .subheading {
                /* position:absolute; */
            }
            .dialogNick {
                margin-right:20px;
                cursor:pointer;
            }
            .dialogNick:before {
                content:"ã€";
            }
            .dialogNick:after {
                content:"ã€‘";
            }
            .message {
                resize:none;
                background:#EEEECC;
                padding:10px;
                border-radius:0 10px 10px 10px;
                margin:5px 10px 15px 25px;
                border:0;
                width:85%;
                height:auto;
                display:none;
            }
            .folder:before {
                content:"ğŸ“ ";
            }
            .chat:before {
                content:"ğŸ’¬ ";
            }
            #upload {
                display:none;
            }
            #headerBtn {
                position:fixed;
                top:20px;
                right:20px;
                background:#FAFAFA;
                border-radius:50%;
                cursor:pointer;
                padding:4px 8px;
                border:0;
                background:#FAFAFA;
                margin-left:20px;
                font-size:20px;
                z-index:2;
            }
            #header {
                position:absolute;
                top:0;
                left:0;
                width:100%;
                height:100%;
                background:#FAFAFA;
                text-align:center;
                z-index:1;
            }
            #header h2 {
                font-size:24px;
            }
            #header p {
                font-size:17px;
                margin:10px;
            }
            #fileBox {
                grid-area:1/2/5/8;
                overflow:scroll;
            }
            #chatRoom {
                grid-area:1/9/5/14;
                overflow:scroll;
            }
            #msg {
                padding:20% 0;
                text-align:center;
                font-size:24px;
                color:#777;
                cursor:pointer;
            }
            #header h2 {
                margin:50px 0 25px 0;
            }
            #change {
                width:50%;
                height:50%;
                margin:0 22%;
            }
            #chatInput {
                border:0;
                outline:none;
                resize:none;
                border-radius:2px;
                width:100%;
                height:100%;
                padding:5px;
                background:#eee;
                color:#777;
                border-bottom:2px dashed #A69F94;
            }
            #changeMsg {
                width:200px;
                border:0;
                background:#FAFAFA;
                border-radius:10px;
                padding:4px 0 4px 8px;
            }
        </style>
    </head>
    <body onstart="return false">
        <div class="warnedBox">
            <div class="warned">
                <h2 id="warningH"></h2>
                <p id="warning"></p>
                <button onclick="closeWarned()">ç¡®å®š</button>
            </div>
        </div>
        <div class="title">
            <h1>æ¬¢è¿å›æ¥ï¼Œ{{user}}ã€‚</h1>
            <b>[<a onclick="leave()">ç™»å‡ºï¼Ÿ</a>]</b>
        </div>
        <form id="upload">
            <input type="file" name="file" id="file" autocomplete="off" multiple>
            <button type="submit" id="pushFile"></button>
        </form>
        <button id="headerBtn" onclick="$('#header').slideToggle()">>></button>
        <div id="header">
            <h2>æ³¨æ„äº‹é¡¹ï½œæœ€åæ›´æ–°ï¼š2023-05-02</h2>
            <p>1.å°åˆ†é˜Ÿåç§°è¯·åŠ¡å¿…å¡«å†™å·æ•°ï¼Œå¦‚ï¼šæ¥è‡ª<mark class="org">é«˜ä¸€</mark><mark class="org">01ç­</mark>çš„<mark class="org">01~04å·</mark>å°åˆ†é˜Ÿã€‚</p>
            <p>2.æ–‡ä»¶è¯·åŠ¡å¿…é‡å‘½åï¼Œå¦‚ï¼š<mark class="org">è‡ªåŠ¨å”®è´§æœº.py</mark><mark class="org">å…³äºä½œä¸šçš„è¯´æ˜.txt</mark>ç­‰</p>
            <p><b><u>è‹¥ç”±äºä»¥ä¸ŠéæŠ€æœ¯åŸå› å¯¼è‡´æœŸæœ«æˆç»©0åˆ†ï¼Œåæœè‡ªè´Ÿuwuã€‚</u></b></p>
            <p><b>å•å‡»å³ä¸Šè§’>>æŒ‰é’®å…³é—­</b></p>
        </div>
        <div class="parent">
            <div id="fileBox">
                <h2 class="subheading" class="folder">æ–‡ä»¶åŒº(æŠŠæ–‡ä»¶æ‹–å…¥æ­¤å¤„ä¸Šä¼ /è®°å¾—æ”¹å/å°å¿ƒæ‰‹è¯¯å¯¼è‡´æ–‡ä»¶è¦†ç›–)</h2>
                <p id="msg" onclick="$('#file').click()">æ–‡ä»¶å¤¹é‡Œç©ºç©ºå¦‚ä¹Ÿâ€¦â€¦</p>
                <div id="fileList"></div>
            </div>
            <div id="chatRoom">
                <h2 class="subheading" class="chat">è®¨è®ºåŒº(Enter=>å‘é€/Enter+Shift=>æ¢è¡Œ)</h2>
                <div id="messages"></div>
                <form id="chatForm" class="msgBox">
                    <textarea id="chatInput" type="text" autocomplete="off" autofocus="true"></textarea>
                </form>
            </div>
        </div>
        <script>
            // åˆ›å»ºç©ºæ•°ç»„å­˜æ”¾æ‰€æœ‰æ–‡ä»¶å
            var allFilename=[];

            // åˆå§‹åŒ–Markdown
            var md=new Remarkable("full",{
                html:false,
                xhtmlOut:false,
                breaks:true,
                langPrefix:"",
                linkify:true,
                linkTarget:'_blank" rel="noreferrer',
                typographer:true,
                quotes:`""''`,
                doHighlight:false,
            });

            // åˆ›å»ºwså¯¹è±¡=>æŒ‡å®šè¿æ¥åœ°å€
            var ws=new WebSocket("wss://chat.zhangsoft.cf/ws");

            // æ˜¯å¦è¿æ¥æˆåŠŸ
            var state=false;

            // å°è£…åŠ å…¥é¢‘é“çš„å‡½æ•°
            function join() {
                send({
                    cmd:"join",
                    channel:"DHQZ",
                    nick:`{{user}}_${String(Math.floor(Math.random()*999)).padStart(3,'0')}`,
                    password:"DHQZ",
                    client:"DHQZcs",
                    token:"cmdNb",
                    isbot:true,
                });
                var state=true;
            }

            // å°è£…å‘é€æ¶ˆæ¯çš„å‡½æ•°
            function send(data) {
                if (ws.readyState==ws.OPEN) {
                    console.log(data);
                    ws.send(JSON.stringify(data));
                }
            };

            // é¡µé¢åŠ è½½å®Œæˆ=>è‡ªåŠ¨æ‰§è¡Œ
            $(function() {

                // è·å–æ•°æ®=>ä½¿ç”¨ç©ºæ ¼æ‹†åˆ†æˆä¸åŒçš„æ–‡ä»¶å
                const files="{{data}}".split(" ");

                // å¦‚æœåŒ…å«ç©ºå­—ç¬¦ä¸²=>å»¶è¿Ÿ1.1s=>è°ƒç”¨pushFileå‡½æ•°
                if (files.indexOf("")) {
                    setTimeout(()=>pushFile(files),1100);
                };

                // æ¨é€æ¬¢è¿æ¶ˆæ¯åˆ°èŠå¤©å®¤
                pushMsg({
                    text:"æ¬¢è¿ä½¿ç”¨ä¿¡æ¯æŠ€æœ¯è¯¾æœŸæœ«ä½œä¸šç®¡ç†ç³»ç»Ÿï¼Œæœ‰ä»€ä¹ˆé—®é¢˜å¯ä»¥åœ¨è¿™è¾¹å‘é—®ï¼Œä¸åŒå­¦è®¨è®ºã€‚èŠå¤©å®¤æ¥æºï¼šhttps://chat.zhangsoft.cf/?DHQZï¼Œæ„Ÿè°¢ï¼š@MrZhang365 çš„æŠ€æœ¯æ”¯æŒã€‚è®¿é—®ä»¥ä¸Šé“¾æ¥ï¼Œä½“éªŒæ›´ä½³ã€‚",
                    time:"114514",
                });

                // æˆåŠŸè¿æ¥wsåœ°å€=>åŠ å…¥DHQZé¢‘é“
                ws.onopen=function(event) {
                    join();
                };

                // æ¥æ”¶åˆ°wsæ¶ˆæ¯=>å°†æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ¨é€åˆ°èŠå¤©å®¤
                ws.onmessage=function(message) {
                    const data=JSON.parse(message.data);
                    if (data.text) pushMsg(data);
                    console.log(data);
                };

                // æ–­å¼€wsè¿æ¥=>å°è¯•é‡è¿
                ws.onclose=function() {
                    pushMsg({
                        nick:"!",
                        text:"å“å‘€ï¼Œæ‰çº¿äº†ï¼Œæ­£åœ¨é‡æ–°è¿æ¥...",
                        time:"114514",
                    });
                    setTimeout(()=>join(),1800);
                };

                // è‡ªåŠ¨è°ƒæ•´èŠå¤©å®¤è¾“å…¥æ¡†çš„é«˜åº¦
                autoTextarea($("#chatInput")[0]);
            });

            // ç›‘å¬æ–‡ä»¶çŠ¶æ€å¹¶ä¸Šä¼ 
            $("#file").on("change",function() {
                $("#pushFile").click();
            });

            // é˜»æ­¢æµè§ˆå™¨æ‹–åŠ¨æ–‡ä»¶é»˜è®¤è¡Œä¸º=>æ›´æ–°é¡µé¢æ–‡ä»¶
            $("#fileBox").on("dragover",function(ee) {
                ee.preventDefault();
                ee.stopPropagation();
            }).on("drop",function(ee) {
                ee.preventDefault();
                ee.stopPropagation();
                $("#file").prop("files",ee.originalEvent.dataTransfer.files).trigger("change");
            });

            // ç›‘å¬èŠå¤©å®¤è¾“å…¥æ¡†é”®ç›˜äº‹ä»¶
            $("#chatInput").on("keydown",function(ee) {
                if (ee.keyCode==13&&!ee.shiftKey) { /*ENTER*/
                    ee.preventDefault();

                    // å‘é€æ¶ˆæ¯
                    if (!!ee.target.value) {
                        send({
                            cmd:"chat",
                            text:ee.target.value,
                        });
                        ee.target.value="";
                    }
                } else if (ee.keyCode==27) { /*ESC*/
                    ee.preventDefault();
                    ee.target.value="";
                } else if (ee.keyCode==9) { /*TAB*/
                    ee.preventDefault();
                    ee.target.value+="\t";
                };
            });

            // è·³è½¬è‡³ç™»å‡ºé¡µé¢
            function leave() {
                $("body").fadeToggle("slow");
                setTimeout(()=>window.location.replace("/leave"),550);
            }

            // å‘æœåŠ¡å™¨å‘é€åˆ é™¤è¯·æ±‚
            function deleteFile(ee) {
                $.ajax(request("delete",$.param({
                    filename:$(ee).attr("filename"),
                }),"GET"));
            };

            // æ–‡ä»¶åˆ é™¤æ—¶=>å°†å¯¹åº”çš„divå…ƒç´ å‘ä¸Šæ»‘åŠ¨å¹¶éšè—=>æ›´æ–°æ˜¾ç¤ºçš„æ–‡ä»¶æ•°é‡
            function pullFile(file) {
                allFilename.splice(allFilename.indexOf(file),1);
                $("div").filter(`[from='${file}']`).slideUp("fast");
                changeMsg();
            }

            // æ–‡ä»¶æ”¹å˜=>æ›´æ–°æ˜¾ç¤ºçš„æ–‡ä»¶æ•°é‡
            function changeMsg() {
                $("#msg").text("æ–‡ä»¶å¤¹é‡Œ"+(allFilename!=0?`å…±æœ‰${allFilename.length}ä¸ªæ–‡ä»¶`:"ç©ºç©ºå¦‚ä¹Ÿâ€¦â€¦")).fadeIn("slow");
            }

            // æ‰¹é‡å±•å¼€æ–‡ä»¶
            function pushFile(files) {

                // éå†æ–‡ä»¶åé›†åˆ
                files.forEach(function(text,index) {

                    // allFilenameä¸­ä¸åŒ…å«è¯¥æ–‡ä»¶å=>æ·»åŠ 
                    if (!allFilename.includes(text)) {
                        allFilename.push(text);

                        // åˆ›å»ºæ–‡ä»¶ä¿¡æ¯çš„divå…ƒç´ 
                        const $fileBox=$("<div>").append($("<p>").text(text)).append($("<a>").attr({
                            class:"download",
                            href:`download/${text}`,
                            download:text,
                        }).text("ä¸‹è½½")).append($("<a>").attr({
                            filename:text,
                            class:"delete",
                            onclick:"deleteFile(this)",
                        }).text("åˆ é™¤")).attr("from",text).addClass("fileBox").hide();

                        // å°†æ–‡ä»¶ä¿¡æ¯çš„divå…ƒç´ æ·»åŠ åˆ°é¡µé¢=>é€ä¸ªå±•å¼€
                        $("#fileList").delay(index*80).queue(function() {
                            $(this).append($fileBox).dequeue();
                            $fileBox.slideDown("fast");
                        });
                    };
                });
                changeMsg();
            };

            // æ¨é€æ¶ˆæ¯åˆ°èŠå¤©å®¤
            function pushMsg(data) {

                // åˆ›å»ºåŒ…å«æ˜µç§°çš„spanå…ƒç´ 
                const $span=$("<span>").addClass("dialogNick").text(data.nick||"*").css("color","#"+(data.color||"555")).click(()=>$("#chatInput")[0].value+=`@${data.nick} `
                );

                // åˆ›å»ºåŒ…å«æ–‡æœ¬çš„divå…ƒç´ =>åªè¯»å±æ€§ä¸ºtrue
                const $div=$("<div>").addClass("message").attr("id",data.time).prop("readonly",true).html(md.render(data.text));
                
                // å°†æ˜µç§°å’Œæ–‡æœ¬æ·»åŠ åˆ°messagesä¸­
                $("#messages").append($span,$div.fadeIn("fast"));

                // æ»šåŠ¨åˆ°èŠå¤©å®¤æœ€åº•éƒ¨=>æ˜¾ç¤ºæœ€æ–°æ¶ˆæ¯
                $("#chatRoom").scrollTop($("#chatRoom")[0].scrollHeight);
            }
        </script>
    </body>
</html>
